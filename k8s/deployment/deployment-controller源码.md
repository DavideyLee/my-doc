# deployment controller 初始化

函数为NewDeploymentController，位于kubernete/pkg/controller/deployment包，deployment_controller.go文件

传入DeploymentInformer、ReplicaSetInformer和PodInformer三个Informer，以及一个clientset。三个Informer用于监听对应的资源，并提供对监听资源的本地缓存。

三个Informer均为接口类型，须实现Informer()和Lister()方法。

三个Informer实例类型分别为deploymentInformer、replicaSetInformer和podInformer结构体，在kubernete/pkg/controller/informers包，前两者位于extensions.go，后者位于core.go。三者均嵌入了sharedInformerFactory结构（在kubernete/pkg/controller/informers包的factory.go文件中），sharedInformerFactory.informers用于保存全局唯一的informer（针对一种资源）。

Informer()接口方法返回SharedIndexInformer接口的实例，通过该实例可以监听k8s资源的变更，并注册回调来处理变更事件。如果sharedInformerFactory.informers已存在对应实例则会返回该实例，否则创建一个实例。三个Informer均调用了NewSharedIndexInformer()函数（kubernete/pkg/client/cache包的shared_informer.go文件）创建实例，不同之处在于监听了不同类型的资源。

NewSharedIndexInformer()函数会创建一个sharedIndexInformer结构体（kubernete/pkg/client/cache包的shared_informer.go文件），sharedIndexInformer.indexer实现了带索引的存储结构，其初始化的时候最终会调用NewThreadSafeStore()函数（kubernete/pkg/client/cache包的thread_safe_store.go文件），该函数会创建threadSafeMap结构体，用于缓存资源对象。

threadSafeMap.items为map类型，用来存储资源对象key与资源对象的映射，资源对象key由资源的namespace和name组成。threadSafeMap.indexers和threadSafeMap.indices用来存储索引数据，均为map类型，两者的key均表示索引类型（如按namespace索引，按time索引等，deployment controller逻辑中使用namespace作为索引）。threadSafeMap.indexers的值为函数，用来根据对象生成索引值（如从pod对象中返回namespace）。threadSafeMap.indices的值为map类型，保存索引值与资源对象key集合的映射。

Lister()接口方法返回StoreToDeploymentLister结构体（kubernete/pkg/client/cache包的listers_extensions.go文件），用于读取缓存中的资源。该方法首先会调用Informer()获取sharedIndexInformer，并用sharedIndexInformer.indexer初始化StoreToDeploymentLister。

## sharedIndexInformer运行

sharedIndexInformer运行时会使用NewDeltaFIFO()函数（kubernete/pkg/client/cache包的delta_fifo.go文件）创建一个fifo队列。NewDeltaFIFO()函数会返回DeltaFIFO结构体指针。其中DeltaFIFO.items为map类型，键为资源对象的key，值为Delta结构体的slice，Delta记录了对象的一次操作，包括操作类型字段和本次操作对应的资源对象。DeltaFIFO.queue为字符串slice类型，按入列顺序保存资源对象的key。DeltaFIFO.knownObjects是接口类型，对应的接口方法ListKeys()用来返回资源对象key的列表，GetByKey(key string)返回指定资源对象，DeltaFIFO.knownObjects用于在保存删除操作时辨别资源对象是否已经不存在，sharedIndexInformer会使用indexer字段来赋值给DeltaFIFO.knownObjects。

接下来DeltaFIFO会被用来创建一个Controller结构体（kubernete/pkg/client/cache包的controller.go）指针，并调用*Controller的Run方法。该方法中会创建Reflector结构体（kubernete/pkg/client/cache包的reflector.go）指针，并调用*Reflector的RunUntil方法，该方法会创建一个routine运行*Reflector的ListAndWatch方法。接下来Run方法会执行*Controller的processLoop方法。

### *Reflector的ListAndWatch方法

ListAndWatch方法首先会执行List操作来获取所有监听的资源，并调用*DeltaFIFO的Replace方法将每个资源对象加入队列中，操作为Sync。DeltaFIFO.knownObjects中多余的对象也会被加入队列中（转为DeletedFinalStateUnknown结构体），操作记为Deleted。之后ListAndWatch方法会创建一个routine周期性的执行*DeltaFIFO的Resync方法，该方法会检查DeltaFIFO.knownObjects中所有对象，如果队列中没有该对象的操作则在队列中添加该对象，操作记为Sync。

接下来ListAndWatch方法会调用Watch操作来监听资源的变更，当收到增删改事件时，便将指定资源对象和对应操作（Added、Updated、Deleted）加入到队列中。

### *Controller的processLoop方法

Controller的processLoop方法会调用*DeltaFIFO的Pop方法，该方法将获取DeltaFIFO.queue队首的资源key，并从DeltaFIFO.items获取对应的Delta切片，并调用*sharedIndexInformer的HandleDeltas方法处理切片。

HandleDeltas方法会遍历切片，对Sync、Added和Updated操作的对象更新到sharedIndexInformer.indexer中，对Deleted操作的对象从sharedIndexInformer.indexer中删除。并调用sharedIndexInformer.processor的distribute方法分发对应的增删改事件。

sharedIndexInformer.processor为sharedProcessor结构体指针，该结构体只包含一个listeners字段，类型为*processorListener切片。processorListener.pendingNotifications字段为空接口切片类型，用于保存通知队列。sharedIndexInformer.processor的distribute方法就是遍历sharedProcessor.listeners，再分别调用*processorListener的add方法，add方法将指定的通知append到processorListener.pendingNotifications切片中。

sharedIndexInformer运行时也会调用*sharedProcessor的run方法，该方法会遍历sharedProcessor.listeners，并为每个listener启动两个routine，一个运行*processorListener的run方法，另一个运行*processorListener的pop方法。

*processorListener的pop方法会轮询获取processorListener.pendingNotifications的队首通知，并将该通知写入processorListener.nextCh channel中。

*processorListener的run方法会轮询从processorListener.nextCh读取通知，再调用processorListener.handler对应的方法处理事件。processorListener.handler为ResourceEventHandler接口类型，有三个接口函数OnAdd、OnUpdate和OnDelete。