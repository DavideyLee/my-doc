# Redis持久化

* Redis提供两种持久化方式：RDB文件和AOF日志。
* RDB文件是周期生成的数据快照
* AOF日志记录的是每次更新操作。Redis会重写AOF日志以免日志过于庞大。
* Redis可以不使用任何持久化。也可以同时使用两种持久化方法，此时Redis重启会使用AOF日志进行数据恢复（因为AOF日志会保证数据更完整）。

## 待验证

两者在较大数据量条件下的恢复效率。
两者对Redis性能的影响。（都不使用、使用其一、都使用）

## RDB优缺点

### 优点

* 适于做备份。
* 适于做故障恢复。RDB内容紧凑，只有单个文件。可将RDB文件发送到其他数据中心。
* 对Redis性能影响小。父进程不会做IO操作，而是交给子进程完成。数据量较大时，RDB恢复速度更快。

### 缺点

* RDB不能满足尽可能减少数据丢失率的需求。
* 在数据量较大时，父进程的fork()操作会非常耗时。在CPU性能不佳且数据量非常大时，在几毫秒甚至1秒内，Redis将暂停处理客户端请求。虽然重写AOF日志也会执行fork()操作，但AOF重写频率可以设置的非常低，而不影响数据持续性。

## AOF优缺点

### 优点

* AOF方式会使得数据更持久。fsync操作在子线程完成。AOF默认策略会每秒执行一次fsync操作，此时发生故障最多丢失一秒内的更新数据。
* AOF日志只会在日志末尾添加内容。即使发生断电，AOF日志记录了不完整的更新指令，redis-check-aof工具可以用来恢复AOF日志。
* 当AOF日志较大时，Redis可以自动重写AOF日志。重写操作非常安全，更新操作会继续记录到旧日志，重写的新日志会保存数据恢复所需的最小操作集合。当新日志重写完成，Redis会切换的新日志记录更新操作。
* AOF日志记录了所有更新指令，易于理解和解析。假如FLUSHALL指令被错误地执行，那么在重写AOF日志前，我们可以停掉Redis服务，并在AOF日志中删除最后一条指令。

### 缺点

* 记录相同的数据集，AOF日志文件比RDB文件大。
* 每秒执行fsync时，AOF会慢于RDB，但性能依旧非常高。RDB在写负载巨大的条件下更能保证延迟时间。

## RDB快照

Redis默认将RDB快照保存在dump.rdb文件中。可以调用SAVE或BGSAVE指令手动生成，也可设置Redis的save配置指定每隔N秒且至少M次更新时生成RDB快照。该配置可以设置多个，满足一个就会触发。

<pre>
    save 60 1000
</pre>

快照生成工作原理：

* Redis执行fork生成子进程。
* 子进程将数据写入临时的RDB文件。
* 新RDB文件写完后替换旧文件。

## Append-only file（AOF）

快照无法提供非常好的数据持久性，不能满足要求数据完全持久的场景。AOF（1.1以上版本）是Redis提供的可选的、提供完全持久策略的备份工具。用以下方式可在配置文件中打开AOF开关：

<pre>
    appendonly yes
</pre>

打开后，每个更新操作都将记录到AOF的末尾。Redis重启时可以重新执行这些更新操作。

### 日志重写

AOF会随着更新操作次数增加而越来越大。为此Redis支持AOF重写特性，重写后的AOF只保存恢复数据需要的最短指令序列。可以使用BGREWRITEAOF指令触发重写，也可以通过配置完成（2.4以上版本）。

### AOF持久性

Redis通过fsync调用记录AOF日志，Redis有三种fsync配置：

* 每次更新都调用fsync。效率很低，但完全持久。
* 每秒中执行一次fsync。足够快，接近RDB快照，但会丢失1秒内的更新。默认值。
* 从不执行fsync。

### AOF问题处理

Redis服务可能会在写AOF文件时宕机，有可能使得AOF文件无法用来恢复Redis服务。此时按以下步骤操作：

* 备份AOF文件
* 使用redis-check-aof工具：redis-check-aof --fix AOFFile
* 使用diff -u检查两个AOF文件的不同（可选）。
* 使用修复后的AOF日志重启服务

### AOF重写操作工作原理

* Redis执行fork生成子进程。
* 子进程将重写的内容写入临时文件
* 父进程在内存中维护一个buffer，积累期间的所有更新操作。同时，这些操作也会记录到旧的AOF日志中。
* 子进程完成重写后，主进行会收到一个信号并将buffer中的所有更新记录到重写的AOF日志尾部。
* Redis自动切换新旧日志。

### RDB切换到AOF

以下方法针对2.2及以上版本

* 备份dump.rdb
* 执行redis-cli CONFIG SET appendonly yes
* 执行redis-cli CONFIG SET save ""
* 确保key数量一致
* 确保更新操作被记录到AOF中

第一条指令将开启AOF。第二条指令用以关闭RDB，这个操作是可选的，可以同时使用两种持久化方法。
注意：记得要修改redis.conf的AOF开关。否则下次重启后，AOF仍为关闭状态。

### AOF和RDB的协同

Redis（2.4之后）保证AOF重写和RDB快照生成不会同时进行，以避免大量的磁盘IO。如果同时发生，会按先后顺序进行调度。
AOF和RDB同时使用时，Redis重启时会使用AOF日志，因为AOF可最大限度的保证数据持久性。

## 备份Redis数据

Redis对数据备份非常友好，因为RDB文件可以在Redis运行时复制。建议参考以下方法备份数据：

* 创建cron任务，周期性的复制RDB文件到指定目录
* 在cron任务中制定清除旧文件的策略
* 将RDB快照发送到其他数据中心或至少发送到其他物理机，至少每天一次。

