## 主从复制

* Redis使用异步复制策略。
* 一个主节点可以有多个从节点。从节点也可以与多个从节点连接。
* 复制过程在主节点是非阻塞的，在进行初始化同步时主节点可以继续处理请求。
* 复制过程在从节点也是非阻塞的。可以将从节点配置为在初始化同步期间可以使用旧版本的数据处理请求。此外，还可以配置为与主节点连接断开时向客户端返回错误。初始化同步完成后，旧版本的数据会被新版本数据替换，这段时间很短，而这期间从节点会阻塞外来的连接。
* 复制可以用来实现读扩展，还可以简单地实现数据冗余
* 使用复制机制可以避免在主节点记录日志（注释redis.conf所有save配置项），而由一个从节点记录日志。此时要注意主节点不能自动重启，因为主节点没有日志，重启后没有任何数据，从节点的数据会被清空。

## 工作原理

* 从节点建立连接后，向主节点发送一个SYNC指令。
* 主节点开始在后台进行数据保存并开始缓存所有更新操作。后台保存完成后，主节点将数据文件传给从节点。从节点首先将其保存在硬盘上，再加载到内存中。主节点之后会向从节点发送缓存的所有更新操作。以上操作都是通过一连串的、与Redis协议格式相同的指令完成。（可以使用telnet模拟上述操作，在发送SYNC指令后将会看到一大块的数据传输，之后所有主节点收到的指令也会下发到telnet会话中。）
* 从节点会自动重建与主节点的连接。如果主节点同时收到多个从节点的同步请求，主节点将会执行一次后台保存操作。
* 主从节点重连后会执行一次完整的同步流程。在2.8版本之后，也可以执行简易的同步流程。

## 简易同步

从2.8版本之后，Redis主从节点重建连接后通常执行简易同步流程。
简易同步通过主节点在内存中保存复制流的工作日志实现。主从节点间协商一个复制偏移量和主节点的运行id。重连后，如果主节点的运行id相同，并且从节点的复制偏移量在主节点的工作日志中存在，那么数据同步将从偏移量指定的位置同步。以上两个条件均不满足时，将使用完整的同步流程复制数据。由于运行id不会被持久化，从节点重启后一定会执行完整的同步流程。
简易同步流程在节点间使用PSYNC指令。2.8版本后的Redis从节点能够检测主节点是否支持PSYNC指令，如果不支持，从节点会使用SYNC指令进行完整同步。

## 复制功能配置

使用主从复制非常简单，只需在从节点配置文件中配置以下内容：

<pre>
    slaveof 192.168.1.1 6379
</pre>

也可以在从节点执行SLAVEOF指令来使用主从复制。
简易同步有一些参数可通过配置来修改，具体参考Redis各版本的配置文件示例。

## 只读从节点

Redis从2.6版本之后开始支持从节点的只读模式，并作为默认模式使用。可通过slave-read-only配置项修改。也可以通过CONFIG SET指令在线修改。
只读从节点将拒绝所有的更新操作。

## 设置从节点的验证信息

如果主节点通过requirepass配置设置了密码，那么从节点需要在同步时提供密码。通过以下配置来设置密码：

<pre>
    masterauth <password>
</pre>

## 写一致性机制

2.8版本后，Redis主节点可以配置为至少有N个从节点存活时才接收写请求。
由于Redis使用异步复制策略，不能保证从节点同步到写操作，因此会存在数据丢失窗口。该特性的工作原理如下：

* 从节点每秒向主节点发送ping，确认处理的同步次数。
* 主节点会记录每个从节点上一次ping的时间。
* 用户可以配置在指定时间内（秒）可以出现延迟的最少从节点数量。

只要至少有N个从节点延迟在M秒内，那么主节点就可以继续执行更新指令。
这个机制可以看做是一种对CAP理论中C（一致性）的不严格的实现，当一个更新操作的一致性无法保证时，该操作将被拒绝。这种机制还是可以限制数据丢失的时间窗口。
该机制对应的配置为：

<pre>
    min-slaves-to-write <number of slaves>
    min-slaves-max-lag <number of seconds>
</pre>
